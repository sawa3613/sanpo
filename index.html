<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>高知市 散歩コース自動生成アプリ</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
    }
    #controls {
      padding: 10px;
      background: #f4f4f4;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    #map {
      height: calc(100vh - 70px);
    }
    button {
      padding: 6px 14px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<div id="controls">
  <label>
    距離(km):
    <input type="number" id="distance" value="3" step="0.5" min="1">
  </label>

  <label>
    モード:
    <select id="mode">
      <option value="kochiplan">高知らしいおすすめ散歩</option>
      <option value="random">完全ランダム散歩</option>
    </select>
  </label>

  <label>
    雰囲気:
    <select id="mood">
      <option value="quiet">静か</option>
      <option value="lively">にぎやか</option>
    </select>
  </label>

  <button onclick="createRoute()">散歩コース作成</button>
</div>

<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ===============================
   初期設定
=============================== */

const START = [33.5597, 133.5311]; // 高知城

const map = L.map("map").setView(START, 14);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "© OpenStreetMap contributors"
}).addTo(map);

L.marker(START).addTo(map).bindPopup("スタート：高知城");

let routeLayer;

/* ===============================
   高知市スポット定義
=============================== */

const kochiSpots = [
  { name: "高知城", lat: 33.5597, lng: 133.5311, mood: "lively" },
  { name: "ひろめ市場", lat: 33.5595, lng: 133.5319, mood: "lively" },
  { name: "城西公園", lat: 33.5618, lng: 133.5245, mood: "quiet" },
  { name: "鏡川みどりの広場", lat: 33.5509, lng: 133.5206, mood: "quiet" },
  { name: "鏡川河畔", lat: 33.5488, lng: 133.5162, mood: "quiet" }
];

/* ===============================
   メイン処理
=============================== */

function createRoute() {
  const mode = document.getElementById("mode").value;
  const distanceKm = Number(document.getElementById("distance").value);

  if (mode === "kochiplan") {
    createKochiRoute(distanceKm);
  } else {
    createRandomRoute(distanceKm);
  }
}

/* ===============================
   高知らしいおすすめ散歩
=============================== */

function createKochiRoute(distanceKm) {
  const mood = document.getElementById("mood").value;
  const start = kochiSpots[0];

  const waypointCount = distanceKm <= 3 ? 2 : 3;

  const preferred = kochiSpots.filter(
    s => s.mood === mood && s.name !== "高知城"
  );

  const fallback = kochiSpots.filter(
    s => s.mood !== mood && s.name !== "高知城"
  );

  const selected = [...preferred, ...fallback]
    .sort(() => Math.random() - 0.5)
    .slice(0, waypointCount);

  const points = [
    [start.lat, start.lng],
    ...selected.map(s => [s.lat, s.lng]),
    [start.lat, start.lng]
  ];

  drawRoute(points);
}

/* ===============================
   完全ランダム散歩
=============================== */

function createRandomRoute(distanceKm) {
  const distanceM = distanceKm * 1000;
  const points = [START];

  for (let i = 0; i < 3; i++) {
    const angle = Math.random() * Math.PI * 2;
    const offset = (distanceM / 30000) * Math.random();

    const lat = START[0] + Math.cos(angle) * offset;
    const lng = START[1] + Math.sin(angle) * offset;

    points.push([lat, lng]);
  }

  points.push(START);
  drawRoute(points);
}

/* ===============================
   ルート描画（OSRM）
=============================== */

function drawRoute(points) {
  const coords = points
    .map(p => `${p[1]},${p[0]}`)
    .join(";");

  const url =
    `https://router.project-osrm.org/route/v1/foot/${coords}` +
    `?overview=full&geometries=geojson`;

  fetch(url)
    .then(res => res.json())
    .then(data => {
      if (routeLayer) map.removeLayer(routeLayer);

      routeLayer = L.geoJSON(data.routes[0].geometry, {
        style: {
          color: "#2e7d32",
          weight: 5
        }
      }).addTo(map);

      map.fitBounds(routeLayer.getBounds());
    });
}
</script>

</body>
</html>
